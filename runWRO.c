#pragma config(Sensor, S1,     ,               sensorEV3_Color, modeEV3Color_RGB_Raw)
#pragma config(Sensor, S2,     ,               sensorEV3_Color, modeEV3Color_RGB_Raw)
#pragma config(Sensor, S3,     ,               sensorI2CCustom9V)
#pragma config(Sensor, S4,     ,               sensorI2CCustom9V)
#pragma config(Motor,  motorA,          leftMotor,     tmotorEV3_Medium, openLoop, encoder)
#pragma config(Motor,  motorB,          rightMotor,    tmotorEV3_Medium, openLoop, encoder)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

#define READ
#include "include/includes.h"

short markers[2] = {0, 0};
short elements[4] = {0, 0, 0, 0};
int encoders_markers[2] = {390, 470};
int encoders_elements[4] = {460, 605, 745, 885};

void getCenterThenBorderElements(){
    setDefaultLine();
    lineFollowEncoder(30, 80, 20, 235);
    changePosGrabberD(80, grabberD.openForwardMax);
    arcEnc(30, -30, 50, 20, 120);
    stopMove(100);

    arcAngle(30, 30, 40, 20, 20);

    arcEnc(-30, 30, 40, 20, 80);
    changePosGrabberD(80, grabberD.closeBoth);
    stopMove(200);
    arcEnc(30, -30, 40, 20, 160);

    arcAngle(-30, -30, 40, 20, 36);

    changePosGrabberD(80, grabberD.openForwardMax);
    arcEnc(-30, 30, 40, 20, 165);
    changePosGrabberD(80, grabberD.closeBoth);
    stopMove(200);
    arcEnc(30, -30, 40, 20, 195);
    changePosGrabberC(80, grabberC.maxUp);
    arcAngle(30, 30, 40, 20, 16);
}

void getBorderThenCenterElements(){
    setDefaultLine();
    arcAngle(50, 0, 100, 40, 40);
    arcEnc(-30, 30, 40, 40, 165);
    arcEnc(-75, 40, 50, 35, 175);
    arcEnc(-35, 35, 35, 20, 45);
    changePosGrabberD(80, grabberD.openForwardMax);
    stopMove(150);

    arcAngle(50, 0, 100, 40, 93);
    arcAngle(0, -50, 100, 40, 115);
    changePosGrabberD(80, grabberD.openBackwardMin);
    stopMove(150);

    arcEnc(-30, 30, 40, 20, 250);
    changePosGrabberD(80, grabberD.openForwardMax);
    stopMove(150);

    arcAngle(0, -30, 100, 40, 80);
    arcAngle(30, 0, 100, 40, 80);
    stopMove(200);

    lineFollowEncoder(20, 80, 20, 220);
    changePosGrabberD(80, grabberD.closeBoth);
    stopMove(150);
    changePosGrabberC(80, grabberC.maxUp);
}

void getOneByOneFromLeft(){
    setDefaultLine();
    arcAngle(20, 20, 100, 20, 90);
    stopMove(100);
    arcAngle(-80, 16, 80, 20, 90);
    arcEnc(-20, 20, 20, 20, 20);
    changePosGrabberD(80, grabberD.openForwardMax);
    stopMove(100);
    arcEnc(20, -20, 20, 20, 40);
    stopMove(200);
    arcAngle(80, -16, 80, 20, 90);
    stopMove(100);
    arcEnc(20, -20, 50, 20, 130);
    stopMove(100);
    arcAngle(-20, -20, 100, 20, 90);
    stopMove(100);
    arcEnc(-20, 20, 20, 15, 180);
    changePosGrabberD(80, grabberD.closeBoth);
    stopMove(200);
    arcAngle(0, -90, 80, 50, 90);
    arcEnc(-20, 20, 20, 15, 45);
    stopMove(200);

    arcAngle(20, 20, 80, 20, 90);
    changePosGrabberD(60, grabberD.openBackwardMax);
    stopMove(550);

    setDefaultLine();
    lineFollowEncoder(20, 20, 20, 180);
    stopMove(0, false, false);
    arcEnc(-20, 20, 20, 20, 60);
    stopMove(100);
    changePosGrabberD(80, grabberD.closeBoth);
    stopMove(550);
    changePosGrabberC(100, grabberC.maxUp);
}

void getOneByOneFromRight(){
    setDefaultLine();
    arcAngle(-20, -20, 100, 20, 90);
    stopMove(100);
    arcAngle(-15, 80, 80, 20, 90);
    arcEnc(-20, 20, 20, 20, 40);
    changePosGrabberD(80, grabberD.openForwardMax);
    stopMove(100);
    arcEnc(20, -20, 20, 20, 40);

    arcAngle(15, -80, 80, 20, 90);
    stopMove(100);
    arcEnc(20, -20, 50, 20, 180);
    stopMove(100);
    arcAngle(20, 20, 100, 20, 90);
    stopMove(100);
    arcEnc(-20, 20, 20, 15, 200);
    changePosGrabberD(80, grabberD.closeBoth);
    stopMove(200);
    arcAngle(90, 0, 80, 50, 90);
    arcEnc(-20, 20, 20, 15, 25);
    stopMove(200);

    arcAngle(-20, -20, 80, 20, 90);
    changePosGrabberD(60, grabberD.openBackwardMax);
    stopMove(550);

    setDefaultLine();
    lineFollowEncoder(20, 20, 20, 180);
    arcEnc(-20, 20, 20, 20, 65);
    stopMove(100);
    changePosGrabberD(80, grabberD.closeBoth);
    stopMove(550);
    changePosGrabberC(100, grabberC.maxUp);
}

void getTwoPairsFromLeft(){
    arcAngle(20, 0, 80, 20, 90);
    arcAngle(-70, 20, 80, 40, 90);
    arcEnc(-20, 20, 40, 20, 140);
    changePosGrabberD(100, grabberD.openForwardMax);
    stopMove(200);

    arcAngle(20, 0, 80, 20, 80);
    arcAngle(0, -20, 80, 20, 80);
    stopMove(200);
    arcEnc(-20, 20, 50, 20, 250);
    changePosGrabberD(100, grabberD.closeBoth);
    stopMove(200);

    changePosGrabberC(80, grabberC.maxUp);
    arcAngle(0, -20, 80, 20, 50);
    arcAngle(20, 0, 80, 20, 50);
    stopMove(200);
}

void getTwoPairsFromRight(){
    arcAngle(0, -20, 80, 20, 90);
    arcAngle(-20, 80, 80, 40, 90);
    arcEnc(-20, 20, 40, 20, 140);
    changePosGrabberD(100, grabberD.openForwardMax);
    stopMove(200);

    arcAngle(0, -20, 80, 20, 84);
    arcAngle(20, 0, 80, 20, 84);
    stopMove(200);
    arcEnc(-20, 20, 50, 20, 250);
    changePosGrabberD(100, grabberD.closeBoth);
    stopMove(200);

    changePosGrabberC(80, grabberC.maxUp);
    arcAngle(20, 0, 80, 20, 60);
    arcAngle(0, -20, 80, 20, 60);
    stopMove(200);
}

void start(){
    readColors(encoders_markers, markers, 2, &CDSensor3);

    arcEnc(-40, 40, 50, 50, 200);
    setLeftSensorBlackLineBlackStop(1, 1);
    lineFollowCross(50, 50, 1);
    arcEnc(-50, 50, 100, 15, 250);
    stopMove(200);

    arcEnc(20, -20, 100, 15, 50);
    arcAngle(0, -40, 70, 20, 50);
    arcAngle(-40, 0, 70, 15, 40);
    arcEnc(-50, 50, 100, 15, 150);
    changePosGrabberC(100, grabberC.maxUpWithoutShip);
    arcAngle(-20, 80, 90, 20, 180);
    arcEnc(-20, 20, 30, 20, 60);
    stopMove(200);
    changePosGrabberC(100, grabberC.maxUp);
    stopMove(400);
    arcAngle(40, 40, 60, 40, 186.3); //field_momento
    stopMove(200);
    readColors(encoders_elements, elements, 4, &CDSensor3);
    arcEnc(-20, 20, 80, 80, 950);
    changePosGrabberC(100, grabberC.maxUpWithoutShip);
    arcEnc(-80, 80, 80, 20, 230);
    stopMove(200);
    arcEnc(20, -20, 20, 15, 190);
    arcAngle(80, -10, 80, 20, 90);
    arcEnc(20, -20, 20, 15, 100);
    stopMove(2000);
    changePosGrabberC(80, grabberC.maxDown);
    changePosGrabberD(80, grabberD.openBackwardMin);
    setDefaultLine();
    stopMove(200);
    lineFollowEncoder(20, 40, 20, 180);
    stopMove(200);

    // shit
    if (markers[0] == -1){
        markers[0] = 4;
    }
    if (markers[1] == -1){
        markers[1] = 4;
    }
    //

    short markersIndexies[2] = {0, 0};
    bool firstFound = false;
    bool secondFound = false;

    for(short index = 0; index < 4; index++){
        if (markers[0] == elements[index] && !firstFound){
            markersIndexies[0] = index;
            firstFound = true;
        }
        else if (markers[1] == elements[index] && !secondFound){
            markersIndexies[1] = index;
            secondFound = true;
        }
    }

    eraseDisplay();
    displayCenteredTextLine(1, "indexies_need: %d %d", markersIndexies[0], markersIndexies[1]);
    displayCenteredTextLine(4, "elements: %d %d %d %d", elements[0], elements[1], elements[2], elements[3]);
    displayCenteredTextLine(8, "markers: %d %d", markers[0], markers[1]);

    if ((markersIndexies[0] == 0 && markersIndexies[1] == 2) || (markersIndexies[1] == 0 && markersIndexies[0] == 2)){
        getOneByOneFromLeft();
    }
    else if ((markersIndexies[0] == 1 && markersIndexies[1] == 3) || (markersIndexies[1] == 1 && markersIndexies[0] == 3)){
        getOneByOneFromRight();
    }
    else if ((markersIndexies[0] == 0 && markersIndexies[1] == 1) || (markersIndexies[1] == 0 && markersIndexies[0] == 1)){
        getTwoPairsFromLeft();
    }
    else if ((markersIndexies[0] == 2 && markersIndexies[1] == 3) || (markersIndexies[1] == 2 && markersIndexies[0] == 3)){
        getTwoPairsFromRight();
    }
    else if ((markersIndexies[0] == 1 && markersIndexies[1] == 2) || (markersIndexies[1] == 1 && markersIndexies[0] == 2)){
        getCenterThenBorderElements();
    }
    else if ((markersIndexies[0] == 0 && markersIndexies[1] == 3) || (markersIndexies[1] == 0 && markersIndexies[0] == 3)){
        getBorderThenCenterElements();
    }

    arcAngle(20, 20, 60, 15, 180);
    lineFollowCross(20, 60, 1);
    changePosGrabberC(100, grabberC.upForDrop);
    lineFollowEncoder(60, 80, 15, 430);
    stopMove(100);
    changePosGrabberD(30, grabberD.dropFirstTwo);
    stopMove(200);
    changePosGrabberC(100, grabberC.maxUpWithoutShip);
    arcEnc(-20, 20, 15, 15, 150);
    changePosGrabberC(100, grabberC.maxUp);
    stopMove(450);

    arcEnc(20, -20, 30, 30, 135);
    arcAngle(30, -80, 90, 40, 90);
    arcAngle(20, 20, 70, 25, 180);
    lineFollowCross(20, 60, 1);
    lineFollowEncoder(60, 80, 15, 350);
    changePosGrabberC(100, grabberC.maxUpWithoutShip);
    stopMove(100);
    arcEnc(20, -20, 80, 20, 260);
    changePosGrabberC(100, grabberC.maxUp);
    stopMove(50);
    arcAngle(20, 20, 90, 15, 90);
    setDefaultLineGreyCross();
    lineFollowEncoder(20, 60, 60, 300);
    lineFollowCross(60, 15, 1);

    arcAngle(20, 0, 50, 20, 59);
    changePosGrabberC(100, grabberC.maxDown);
    arcAngle(0, -20, 50, 20, 59);

    arcEnc(-20, 20, 30, 15, 150);
    changePosGrabberD(100, grabberD.closeBoth);
    stopMove(100);
    changePosGrabberC(100, grabberC.maxUpWithoutShip);

    arcEnc(20, -20, 30, 15, 45);
    stopMove(200);
    arcAngle(20, 20, 80, 20, 90);
    stopMove(100);

    arcEnc(-20, 20, 30, 15, 460);
    changePosGrabberC(100, grabberC.maxUp);
    stopMove(200);
    arcAngle(-22, 80, 90, 60, 180);


    lineFollowCross(40, 60, 1);
    lineFollowEncoder(60, 90, 90, 1000);
    lineFollowCross(90, 40, 1);

    arcEnc(-30, 30, 30, 30, 95);
    arcEnc(40, -40, 40, 40, 20);

    arcAngle(0, -40, 70, 40, 30);
    arcAngle(-40, 0, 70, 40, 25);
    lineFollowEncoder(40, 80, 40, 580);
    arcEnc(40, -40, 40, 40, 300);
    changePosGrabberC(100, grabberC.maxUpWithoutShip);
    stopMove(200);
    arcEnc(20, -20, 40, 20, 50);
    changePosGrabberC(100, grabberC.upForDrop);
    stopMove(200);
    changePosGrabberD(100, grabberD.openBackwardMax);
    sleep(500);
    changePosGrabberC(100, grabberC.maxUp);
    setDefaultLineWhiteCross();
    arcEnc(20, -20, 20, 20, 200);
    arcAngle(-20, -20, 80, 20, 180);

    lineFollowEncoder(20, 30, 100, 30);
    lineFollowCross(30, 50, 1);

    arcEnc(-50, 50, 50, 15, 250);
    stopMove(10000);
}


task main(){
    initAll();
    float now = getBatteryVoltage();
    eraseDisplay();
    sleep(1000);

    now = getBatteryVoltage();
    displayCenteredTextLine(1, "%f", now);
    if (now < 8){
        playSound(soundException);
    }

    setLeftSensorBlackLineBlackStop(1, 1);
    start();

    stopMove(20000);
    fileClose(fileHandle);
}
