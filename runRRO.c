#pragma config(Sensor, S1,     ,               sensorEV3_Color, modeEV3Color_RGB_Raw)
#pragma config(Sensor, S2,     ,               sensorEV3_Color, modeEV3Color_RGB_Raw)
#pragma config(Sensor, S3,     ,               sensorEV3_GenericI2C, modeEV3I2C_9V)
#pragma config(Motor,  motorA,          leftMotor,     tmotorEV3_Medium, openLoop, encoder)
#pragma config(Motor,  motorB,          rightMotor,    tmotorEV3_Medium, openLoop, encoder)
#pragma config(Motor,  motorC,           ,             tmotorEV3_Medium, openLoop, encoder)
#pragma config(Motor,  motorD,           ,             tmotorEV3_Medium, openLoop, encoder)
//*!!Code automatically generated by 'ROBOTC' configuration wizard               !!*//

#define READ

#include "include/includes.h"

void vsos(int deg) {
	if (deg <= 40) {
		arcEnc(-30, 30, 15, 15, deg);
	} else {
		arcEnc(-35, 35, 35, 15, deg - 50);
		arcEnc(-15, 15, 15, 15, 50);
	}
	changePosGrabberC(100, grabberC.firstLevelT);
	stopMove(100);
	changePosGrabberD(25, grabberD.openStack);
	stopMove(300);
	changePosGrabberC(100, grabberC.maxDown);
	changePosGrabberD(30, grabberD.openStack2);
	stopMove(350);
	changePosGrabberD(60, grabberD.close);
	stopMove(350);
	changePosGrabberC(100, grabberC.firstLevel);
}

void fromClawsToTower() {
	changePosGrabberC(100, grabberC.maxUp);
	stopMove(400);
	arcAccelEnc(35, -35, 35, 20, 200, 70);
	//stopMove(200);
	arcAccelEnc(0, -45, -100, -40, 265, 80);
	stopMove(200);
	arcAccelEnc(45, 0, 100, 40, 265, 80);
	changePosGrabberD(30, grabberD.smallOpen);
	changePosGrabberC(100, grabberC.maxDown);
	stopMove(400);
	arcAccelEnc(-35, 35, 35, 20, 140, 70);
	changePosGrabberD(60, grabberD.close);
	stopMove(300);
	arcAccelEnc(35, -35, 35, 20, 100, 60);
	changePosGrabberD(30, grabberD.smallOpen);
	stopMove(200);
	arcAccelEnc(-35, 35, 35, 20, 70, 30);
	changePosGrabberD(60, grabberD.close);
	stopMove(300);
	changePosGrabberC(100, grabberC.firstLevel);
	vsos(200);
	stopMove(200);
	arcAccelEnc(45, 0, 100, 40, 385, 80);
	stopMove(200);
	arcAccelEnc(0, -45, -100, -40, 385, 80);
	changePosGrabberC(100, grabberC.firstLevel);
	stopMove(200);
	arcAccelEnc(-35, 35, 35, 15, 230, 80);
	stopMove(200);
	changePosGrabberC(100, grabberC.firstLevelT);
	stopMove(300);
	changePosGrabberD(30, grabberD.smallOpen);
	stopMove(400);
	arcAccelEnc(35, -35, 35, 20, 65, 40);
	changePosGrabberC(100, grabberC.maxDown);
	stopMove(600);
	changePosGrabberD(60, grabberD.close);
	stopMove(300);
	arcAccelEnc(35, -35, 35, 20, 110, 60);
	stopMove(200);
	changePosGrabberD(30, grabberD.smallOpen);
	stopMove(500);
	arcAccelEnc(-35, 35, 35, 20, 90, 40);
	changePosGrabberD(60, grabberD.close);
	stopMove(300);
	changePosGrabberC(100, grabberC.firstLevel);
	stopMove(100);
	vsos(190);
}

void takeTwoRAndYFromStart1() {
	arcEnc(-50, 0, -50, -50, 40);
	arcEnc(-50, 50, 100, 50, 400);
	arcAngle(0, 50, 100, 50, 150);
	arcEnc(-80, 80, 80, 80, 100);
	changePosGrabberC(100, grabberC.firstLevel);
	changePosGrabberD(100, grabberD.smallOpen);
	arcEnc(-80, 80, 80, 30, 240);
	stopMove(200);
	arcAngle(0, -80, -80, -80, 30);
	arcAngle(0, -80, -100, -30, 100, &CDSensor2, 1);
	setRightSensorBlackLineBlackStop(1, 0);
	lineFollowEncoder(50, 50, 50, 200);
	lineFollowCross(MTVarsB.targetV, 60, 1);
	lineFollowEncoder(60, 60, 20, 300);
	lineFollowEncoder(20, 20, 20, 70);
	stopMove(200);
	arcAccelAngle(-35, -35, -60, -30, 90, 15);
	stopMove(200);
	changePosGrabberC(100, grabberC.maxDown);
	stopMove(200);
	arcEnc(-35, 35, 35, 20, 120);
	changePosGrabberD(100, grabberD.close);
	stopMove(200);
	changePosGrabberC(100, grabberC.firstLevel);
	arcEnc(0, -40, -70, -30, 365);
	stopMove(100);
	arcEnc(40, 0, 70, 30, 365);
	stopMove(300);
	arcEnc(-35, 35, 100, 25, 190);
	vsos(100);
	stopMove(100);
	arcAngle(50, 0, 100, 50, 120);
	arcEnc(50, -50, 100, 40, 180);
	arcEnc(40, 40, 100, 20, 200, &CDSensor1, 1);
	changePosGrabberC(100, grabberC.firstLevel);
}

void takeSecondPairsFromStart1() {
	setDefaultLine();
	lineFollowEncoder(50, 100, 70, 550);
	changePosGrabberC(100, grabberC.firstLevel);
	lineFollowCross(70, 20, 1);
	stopMove(200);
	arcEnc(0, 45, 70, 35, 130);
	stopMove(200);
	arcEnc(-45, 0, -70, -35, 130);
	arcEnc(-35, 35, 40, 30, 60);
	vsos(90);
	changePosGrabberC(100, grabberC.firstLevel);
	arcEnc(40, 0, 100, 30, 360);
	stopMove(100);
	arcEnc(0, -40, -100, -30, 360);
	stopMove(300);
	arcEnc(-35, 35, 100, 30, 215);
	vsos(80);
	changePosGrabberC(100, grabberC.maxUp);
	arcEnc(35, -35, 35, 25, 80);
	stopMove(200);
	arcAngle(-50, 0, -100, -100, 75);
	arcEnc(-100, 100, 100, 40, 300);
	arcAngle(-40, 0, -100, -40, 105);
	changePosGrabberC(100, grabberC.firstLevel);
	arcEnc(-40, 40, 100, 40, 100);
	stopMove(200);
	arcEnc(-45, -60, -100, -60, 480, &CDSensor2, 1);
}

void throwTwoTowers() {
	changePosGrabberC(100, grabberC.closeClaws);
	setRightSensorBlackLineBlackStop(1, 0);
	lineFollowEncoder(40, 100, 100, 250);
	lineFollowCross(100, 40, 1);
	lineFollowEncoder(40, 30, 30, g_distBetweenSensorsAndWheelBase);
	stopMove(200);
	arcAngle(40, 40, 100, 40, 90, &CDSensor1, 1);
	setDefaultLineYellowCross();
	lineFollowCross(40, 30, 1);
	stopMove(200);
	arcEnc(35, -35, 35, 25, 70);
	changePosGrabberC(100, grabberC.maxDown);
	stopMove(450);
	changePosGrabberD(100, grabberD.smallOpen);
	stopMove(200);
	changePosGrabberC(100, grabberC.maxUp);
	arcEnc(35, -35, 35, 25, 100);
	fromClawsToTower();
	arcEnc(-40, 0, -50, -40, 180);
	arcEnc(-40, 40, 40, 15, 195);
	changePosGrabberC(100, grabberC.maxDown);
	stopMove(300);
	changePosGrabberD(100, grabberD.smallOpen);
	stopMove(200);
	changePosGrabberC(100, grabberC.almostFloor);
	changePosGrabberD(100, grabberD.openStack);
	arcEnc(35, -35, 100, 30, 310);
	arcEnc(35, 35, 100, 40, 319);
}

void twoBGAfterRY() {
	changePosGrabberD(100, grabberD.close);
	changePosGrabberC(100, grabberC.firstLevel);
	setDefaultLineRedCross();
	lineFollowEncoder(25, 90, 90, 230);
	lineFollowCross(90, 90, 1);
	arcEnc(-90, 90, 90, 25, 325);
	arcEnc(-25, 25, 25, 25, 180);
	stopMove(200);
	arcAccelEnc(0, 45, 60, 40, 455, 100);
	stopMove(200);
	arcAccelEnc(-45, 0, -60, -40, 455, 100);
	stopMove(200);
	arcEnc(-35, 35, 15, 15, 50);
	changePosGrabberD(100, grabberD.smallOpen);
	arcEnc(-15, 15, 15, 15, 30);


	stopMove(300);
	changePosGrabberC(100, grabberC.maxDown);
	stopMove(400);
	changePosGrabberD(30, grabberD.close);
	arcEnc(-35, 35, 35, 15, 60);
	stopMove(200);
	changePosGrabberC(100, grabberC.firstLevel);
	stopMove(100);
	arcAccelEnc(45, 0, 100, 40, 365, 100);
	stopMove(200);
	arcAccelEnc(0, -45, -100, -40, 365, 100);
	changePosGrabberC(100, grabberC.firstLevel);
	stopMove(200);
	arcEnc(-35, 35, 40, 20, 125);
	vsos(120);
	changePosGrabberC(100, grabberC.maxUp);
	arcEnc(0, -40, -100, -30, 160);
	stopMove(300);
	arcEnc(-35, 35, 35, 20, 300);
	changePosGrabberC(100, grabberC.maxDown);
	stopMove(600);
	arcEnc(-35, 35, 35, 20, 40);
	changePosGrabberC(100, grabberC.maxUp);
	stopMove(600);
	arcEnc(-60, 10, -100, 30, 120);
	changePosGrabberC(100, grabberC.closeClaws);
	stopMove(300);
	arcEnc(35, -35, 35, 20, 140);
	stopMove(100);
	arcEnc(0, -40, -100, -30, 500);
	changePosGrabberC(100, grabberC.maxUp);
	stopMove(200);
	arcEnc(-35, 35, -100, -20, 900);
	changePosGrabberC(100, grabberC.closeClaws);
	arcEnc(-40, 0, -100, -60, 480);
	arcEnc(-60, 60, 100, 100, 100);
	arcEnc(MTVarsA.targetV, MTVarsB.targetV, 100, 60, 300, &CDSensor1, 1);
	arcEnc(-60, 60, 60, 30, 30);
	arcEnc(0, 60, 100, 50, 100, &CDSensor2, 1);
	//setRightSensorBlackLineBlackStop(1, 0);
	//lineFollowEncoder(50, 100, 40, 200);
	//lineFollowCross(MTVarsB.targetV, 100, 1);
}

void musor() {
	changePosGrabberC(100, grabberC.maxUp);
	setRightSensorBlackLineBlackStop(1, 0);
	arcEnc(0, 50, 100, 40, 410);
	stopMove(100);
	arcEnc(0, -50, -100, -40, 410);
	lineFollowEncoder(50, 100, 40, 80);
	changePosGrabberC(100, grabberC.closeClaws);
	lineFollowCross(40, 100, 1);
	lineFollowEncoder(MTVarsB.targetV, 100, 20, 445);
	lineFollowEncoder(20, 20, 20, 40);
	stopMove(200);
	arcEnc(-40, 0, -100, -30, 250);
	changePosGrabberC(100, grabberC.maxUp);
	stopMove(200);
	arcEnc(-35, 35, 100, 20, 230);
	arcEnc(-20, 20, 20, 20, 50);
	changePosGrabberC(100, grabberC.closeClaws);
	stopMove(300);
	arcEnc(35, -35, 50, 20, 250);
	stopMove(100);
	arcEnc(40, 0, 100, 30, 530);
	changePosGrabberC(100, grabberC.maxUp);
	stopMove(300);
	arcAccelEnc(-35, 35, 100, 20, 1755, 100);
	changePosGrabberC(100, grabberC.closeClaws);
	stopMove(200);
	changePosGrabberC(100, grabberC.maxUp);
	stopMove(300);
	arcEnc(35, -35, 50, 20, 380);
	stopMove(200);
	changePosGrabberC(100, grabberC.kran);
	arcEnc(0, -40, -50, -30, 255);

	stopMove(300);
	arcAccelEnc(-35, 35, 60, 20, 378, 50);
	changePosGrabberC(100, grabberC.maxUp);
	stopMove(200);
	arcEnc(-40, 0, -40, -30, 70);
	stopMove(200);
	//arcEnc(40, 0, 40, 30, 10);
	arcEnc(40, -40, 100, 30, 1030);
	stopMove(200);
	arcEnc(-40, -40, -100, -30, 480, &CDSensor2, 1);
}

void lastTowerAndFinish() {
	setRightSensorBlackLineBlackStop(1, 0);
	lineFollowEncoder(50, 50, 50, 80);
	lineFollowCross(50, 30, 1);
	arcAccelEnc(-45, 0, -60, -40, 205, 80);
	arcAccelEnc(0, 45, 60, 40, 205, 80);
	changePosGrabberC(100, grabberC.firstLevel);
	setLeftSensorBlackLineBlackStop(-1, 0);
	lineFollowEncoder(40, 100, 20, 620);
	getCDValues(&CDSensor3);
	//colSound(CDSensor3.color);
	lineFollowEncoder(20, 20, 20, 100);
	stopMove(200);

	arcAccelAngle(-35, -35, -60, -30, 90, 15);
	stopMove(200);
	vsos(80);
	changePosGrabberC(100, grabberC.firstLevel);
	arcAccelEnc(45, 0, 70, 40, 368, 80);

	stopMove(100);
	arcAccelEnc(0, -45, -70, -40, 368, 80);
	stopMove(300);
	arcEnc(-35, 35, 100, 20, 190);
	vsos(80);
	if (CDSensor3.color == 4) {
		arcEnc(35, -35, 100, 25, 200);
		stopMove(200);
		arcEnc(-35, -35, -100, -25, 454);
		stopMove(200);
		arcEnc(-35, 35, 100, 20, 190);
		changePosGrabberC(100, grabberC.maxDown);
		stopMove(300);
		changePosGrabberD(100, grabberD.bigOpen);
		stopMove(200);
		arcEnc(50, 0, 100, 50, 800);
		arcEnc(50, -50, 100, 30, 700);
	} else {
		arcEnc(0, -40, -100, -40, 90);
		arcEnc(40, -40, 100, 25, 920);
		changePosGrabberC(100, grabberC.maxDown);
		stopMove(300);
		changePosGrabberD(100, grabberD.bigOpen);
		stopMove(200);
		arcEnc(60, -60, 60, 60, 200);
	}
}

task main(){
	initAll();
	stopMove(1300);
	unsigned long varPgmTime = nPgmTime;
	float now = getBatteryVoltage();
	now = getBatteryVoltage();

	if (now < 7.6){
		playSound(soundException);
	}
	takeTwoRAndYFromStart1();
	takeSecondPairsFromStart1();
	throwTwoTowers();
	twoBGAfterRY();
	musor();
	lastTowerAndFinish();
	displayCenteredTextLine(2, "%d", nPgmTime - varPgmTime);

	stopMove(20000);
	fileClose(fileHandle);
}
